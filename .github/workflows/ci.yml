name: Django CI

env:
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  DEBUG_TOGGLE: ${{ secrets.DEBUG_TOGGLE }}
  CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}

on:
  push:
    branches:
      - main
      - dev
      - h-heroku-deploy
  pull_request:
    branches:
      - main
      - dev

jobs:
  test:
    name: Test Django App on ${{ matrix.python-version }}

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.10.4]

    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Tests
        run: |
          python manage.py test
          
  deploy:
    name: Deploy to Heroku
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      
    steps:
      - name: Heroku Action
        # You may pin to the exact commit or the version.
        # uses: CDNievas/heroku-action@c9cf9c85571e67583e44ec92c0d1113f66b0e838
        uses: AkhileshNS/heroku-deploy@v3.12.12
        with:
          # Used for authentication. You can find it in your heroku homepage account settings
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          # Email from Heroku Account
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          # The appname to use for deploying/updating
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          # The branch that you would like to deploy to Heroku
          branch: h-heroku-deploy
          # Set this to true if want to use --force
          # useforce: # optional
          # Set if your app is located in a subdirectory.
          # appdir: # optional, default is 
          # Contents of the Procfile to save and deploy
          # procfile: # optional, default is 
          # Set to true if you need upload files generated dynamically by the GitHub Action to Heroku
          # dynamicFiles: # optional
          # Buildpacks to install on Heroku
          # buildpacks: # optional, default is 
          # Path to an localized env file
          # env_file: # optional, default is 
